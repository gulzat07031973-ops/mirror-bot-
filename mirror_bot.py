from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup, InputMediaPhoto
from aiogram.utils import executor
import os

# --- Ð¢Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð° Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ ---
TOKEN = os.getenv("TELEGRAM_TOKEN")
bot = Bot(token=TOKEN)
dp = Dispatcher(bot)

# --- ÐšÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ¸ Ð¸ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ ---
images = {
    "1": {
        "url": "https://pixabay.com/get/gdff42f2934d7ba4bfb200a848958071b1bc5612cda3bbec69ce04ab3aee85b0d2be2d52aa2985b99cf43c7ba5b1f246b_1280.jpg",
        "desc": "ðŸ”¥ ÐŸÐµÐ¿ÐµÐ» Ð¾Ñ‚ ÐºÐ¾ÑÑ‚Ñ€Ð°\n\nÐ’ÑÑ‘, Ñ‡Ñ‚Ð¾ Ð¼Ð¾Ð³Ð»Ð¾ Ð³Ð¾Ñ€ÐµÑ‚ÑŒ â€” ÑÐ³Ð¾Ñ€ÐµÐ»Ð¾. ÐžÑÑ‚Ð°Ð»ÑÑ Ð¿ÐµÐ¿ÐµÐ» Ð¸ Ñ‚Ð¸ÑˆÐ¸Ð½Ð°.\nÐ­Ñ‚Ð¾ Ð½Ðµ ÑÐ»Ð°Ð±Ð¾ÑÑ‚ÑŒ. Ð­Ñ‚Ð¾ Ð·Ð½Ð°Ðº: Ð¿Ð¾Ñ€Ð° Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒÑÑ.\nÐ”Ð°Ð¶Ðµ Ð² Ð¿ÐµÐ¿Ð»Ðµ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑÑ Ñ‚ÐµÐ¿Ð»Ð¾ â€” Ð´Ð°Ð¹Ñ‚Ðµ ÑÐµÐ±Ðµ Ð²Ñ€ÐµÐ¼Ñ, Ð¸ Ð¾Ð½Ð¾ ÑÐ½Ð¾Ð²Ð° ÑÑ‚Ð°Ð½ÐµÑ‚ Ð¾Ð³Ð½Ñ‘Ð¼."
    },
    "2": {
        "url": "https://pixabay.com/get/geedfa5751428d7164e3ece3f281edb7bb1846ee877c931d8bf0ba347ec5ddf743f555494ba3a88b468e58fbc5fae4db9_1280.jpg",
        "desc": "ðŸ”‹ ÐŸÑƒÑÑ‚Ð°Ñ Ð±Ð°Ñ‚Ð°Ñ€ÐµÑ\n\nÐ Ð°Ð±Ð¾Ñ‚Ð° Ð½Ð° Ð¿Ñ€ÐµÐ´ÐµÐ»Ðµ â€” Ð¸ Ð²Ð¾Ñ‚ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð½Ð¾Ð»ÑŒ.\nÐžÑ€Ð³Ð°Ð½Ð¸Ð·Ð¼ Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ Ð¿Ð°ÑƒÐ·Ñ‹, Ð° ÑÐ¾Ð·Ð½Ð°Ð½Ð¸Ðµ Ð²ÑÑ‘ ÐµÑ‰Ñ‘ Ð¸Ñ‰ÐµÑ‚ Ñ€Ð¾Ð·ÐµÑ‚ÐºÑƒ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¹ Ð½ÐµÑ‚.\nÐŸÐ¾Ð´Ð·Ð°Ñ€ÑÐ´ÐºÐ° Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ð½Ðµ Ñ Ð´ÐµÐ», Ð° Ñ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ â€” Ð½Ðµ Ð´ÐµÐ»Ð°Ñ‚ÑŒ."
    },
    "3": {
        "url": "https://pixabay.com/get/gfbc5fb4174afe5eab80c26bbef1e10112c91ba6ab883bc138ecf74d3c4e7ccfdbde51d2451adcd3d353f551658070662_1280.jpg",
        "desc": "ðŸª¨ Ð¡ÐºÐ°Ð»Ñ‹ Ð¸ Ñ‚Ñ€ÐµÑ‰Ð¸Ð½Ñ‹\n\nÐœÐ¾Ð¶Ð½Ð¾ Ð´Ð¾Ð»Ð³Ð¾ Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ð½Ð°Ð¿Ñ€ÑÐ¶ÐµÐ½Ð¸Ðµ. ÐÐ¾ Ð´Ð°Ð¶Ðµ ÐºÐ°Ð¼ÐµÐ½ÑŒ Ð´Ð°Ñ‘Ñ‚ Ñ‚Ñ€ÐµÑ‰Ð¸Ð½Ñ‹.\nÐžÐ½Ð¸ Ð½Ðµ Ð´ÐµÐ»Ð°ÑŽÑ‚ ÐµÐ³Ð¾ ÑÐ»Ð°Ð±ÐµÐµ. ÐžÐ½Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð³Ð¾Ð²Ð¾Ñ€ÑÑ‚: Â«Ð”Ð°Ð»ÑŒÑˆÐµ Ñ‚Ð°Ðº Ð½ÐµÐ»ÑŒÐ·ÑÂ».\nÐŸÐ¾Ñ€Ð° ÑÐ±Ð°Ð²Ð¸Ñ‚ÑŒ Ð´Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸ Ð½Ð°Ð¹Ñ‚Ð¸ Ð´Ñ€ÑƒÐ³ÑƒÑŽ Ð¾Ð¿Ð¾Ñ€Ñƒ."
    },
    "4": {
        "url": "https://pixabay.com/get/ge00c65d9fa2f21fb5494cc19b61868f1b826da19fbbbf68a88a5b1a5f313470c7650c96464248b869e5b386697231cbb9_1280.jpg",
        "desc": "ðŸŒ± Ð’Ð¾Ð·Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ðµ Ñ€Ð¾ÑÑ‚ÐºÐ°\n\nÐ£ÑÑ‚Ð°Ð»Ð¾ÑÑ‚ÑŒ Ð½Ðµ Ð½Ð°Ð²ÑÐµÐ³Ð´Ð°.\nÐ”Ð°Ð¶Ðµ ÐºÐ¾Ð³Ð´Ð° ÐºÐ°Ð¶ÐµÑ‚ÑÑ, Ñ‡Ñ‚Ð¾ Ð²ÑÑ‘ ÐºÐ¾Ð½Ñ‡ÐµÐ½Ð¾ â€” Ð²Ð½ÑƒÑ‚Ñ€Ð¸ ÑƒÐ¶Ðµ Ð¿Ñ€Ð¾Ð±Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð¶Ð¸Ð·Ð½ÑŒ.\nÐ¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ñ€Ð¾Ð±ÐºÐ¾. ÐŸÐ¾Ñ‚Ð¾Ð¼ ÑÐ¼ÐµÐ»ÐµÐµ.\nÐ’ÑÑ‘ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ðµ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ñ Ð¼Ð°Ð»Ð¾Ð³Ð¾."
    }
}

# --- Ð’Ð¾Ð¿Ñ€Ð¾ÑÑ‹ ---
questions = [
    "ðŸ§  Ð’Ð¾Ð¿Ñ€Ð¾Ñ 1: Ð“Ð´Ðµ Ð² Ñ‚ÐµÐ»Ðµ Ð²Ñ‹ Ð¾Ñ‰ÑƒÑ‰Ð°ÐµÑ‚Ðµ ÑƒÑÑ‚Ð°Ð»Ð¾ÑÑ‚ÑŒ Ð¸Ð»Ð¸ Ð½Ð°Ð¿Ñ€ÑÐ¶ÐµÐ½Ð¸Ðµ?",
    "ðŸ’­ Ð’Ð¾Ð¿Ñ€Ð¾Ñ 2: ÐšÐ°ÐºÐ¸Ðµ Ð¼Ñ‹ÑÐ»Ð¸ ÑƒÑÐ¸Ð»Ð¸Ð²Ð°ÑŽÑ‚ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¾ Ð²Ñ‹Ð³Ð¾Ñ€Ð°Ð½Ð¸Ñ?",
    "ðŸŒŸ Ð’Ð¾Ð¿Ñ€Ð¾Ñ 3: Ð§Ñ‚Ð¾ Ð´Ð»Ñ Ð²Ð°Ñ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð²Ð°Ð¶Ð½Ð¾ ÑÐµÐ¹Ñ‡Ð°Ñ?",
    "ðŸš¶ Ð’Ð¾Ð¿Ñ€Ð¾Ñ 4: ÐšÐ°ÐºÐ¾Ð¹ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ð¹ ÑˆÐ°Ð³ Ðº Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÑŽ ÑÐ½ÐµÑ€Ð³Ð¸Ð¸ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð¿Ñ€ÑÐ¼Ð¾ ÑÐµÐ³Ð¾Ð´Ð½Ñ?",
    "ðŸ“Œ Ð’Ð¾Ð¿Ñ€Ð¾Ñ 5: ÐšÐ°ÐºÐ¾Ð¹ ÑƒÑ€Ð¾Ðº Ð¸Ð· ÑÑ‚Ð¾Ð³Ð¾ Ð¾Ð¿Ñ‹Ñ‚Ð° Ð²Ñ‹ Ð·Ð°Ð¼ÐµÑ‡Ð°ÐµÑ‚Ðµ Ð´Ð»Ñ Ð±ÑƒÐ´ÑƒÑ‰Ð¸Ñ… Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹?"
]

# --- Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ ---
user_data = {}

# --- ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start ---
@dp.message_handler(commands=['start'])
async def start(message: types.Message):
    # ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ
    await message.answer(
        "ðŸ”¥ Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð´ÐµÐ¼Ð¾-Ð²ÐµÑ€ÑÐ¸ÑŽ Ð½ÐµÐ¹Ñ€Ð¾Ð¸Ð³Ñ€Ñ‹ Â«Ð—ÐµÑ€ÐºÐ°Ð»Ð¾Â»! ðŸ”¥\n\n"
        "Ð­Ñ‚Ð° Ð¼Ð¸Ð½Ð¸-Ð¸Ð³Ñ€Ð° Ð¿Ð¾Ð¼Ð¾Ð¶ÐµÑ‚ Ð²Ð°Ð¼ Ð²Ð·Ð³Ð»ÑÐ½ÑƒÑ‚ÑŒ Ð½Ð° ÑÐ²Ð¾Ñ‘ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· 4 Ð¾Ð±Ñ€Ð°Ð·Ð° Ð¸ 5 Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð².\n"
        "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¾Ð´Ð¸Ð½ Ð¾Ð±Ñ€Ð°Ð·, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¾Ñ‚ÐºÐ»Ð¸ÐºÐ°ÐµÑ‚ÑÑ Ð²Ð°Ð¼ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð²ÑÐµÐ³Ð¾:"
    )

    # ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð¿Ð¾Ð´ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ°Ð¼Ð¸
    kb = InlineKeyboardMarkup(row_width=2)
    for k in images:
        kb.insert(InlineKeyboardButton(f"{k}ï¸âƒ£", callback_data=f"img_{k}"))

    # ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÑ€Ð°Ð·Ñƒ Ð²ÑÐµ 4 ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ¸ ÐºÐ°Ðº Ð¼ÐµÐ´Ð¸Ð°-Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ
    media = [InputMediaPhoto(images[k]["url"]) for k in images]
    await bot.send_media_group(message.chat.id, media)
    await message.answer("ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð¿Ð¾Ð´ Ð¿Ð¾Ð½Ñ€Ð°Ð²Ð¸Ð²ÑˆÐµÐ¹ÑÑ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ¾Ð¹:", reply_markup=kb)


# --- Ð’Ñ‹Ð±Ð¾Ñ€ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ¸ ---
@dp.callback_query_handler(lambda c: c.data.startswith("img_"))
async def on_image(callback: types.CallbackQuery):
    uid = callback.from_user.id
    idx = callback.data.split("_")[1]
    user_data[uid] = {"chosen": idx, "answers": []}

    # ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¾Ð±Ñ€Ð°Ð·Ð°
    await bot.send_message(uid, images[idx]["desc"])

    # ÐšÐ½Ð¾Ð¿ÐºÐ° "Ð”Ð°Ð»ÐµÐµ" Ðº Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ð¼
    next_kb = InlineKeyboardMarkup().add(
        InlineKeyboardButton("âž¡ï¸ Ð”Ð°Ð»ÐµÐµ", callback_data="q_0")
    )
    await bot.send_message(uid, "ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Â«Ð”Ð°Ð»ÐµÐµÂ», Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹.", reply_markup=next_kb)


# --- Ð’Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¿Ð¾ ÑˆÐ°Ð³Ð°Ð¼ ---
@dp.callback_query_handler(lambda c: c.data.startswith("q_"))
async def on_question(callback: types.CallbackQuery):
    uid = callback.from_user.id
    i = int(callback.data.split("_")[1])

    # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚
    if i > 0 and callback.message.text:
        user_data[uid]["answers"].append(callback.message.text)

    if i < len(questions):
        kb = InlineKeyboardMarkup().add(
            InlineKeyboardButton("âž¡ï¸ Ð”Ð°Ð»ÐµÐµ", callback_data=f"q_{i+1}")
        )
        await bot.send_message(uid, questions[i], reply_markup=kb)
    else:
        # Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
        await bot.send_message(uid, f"Ð’Ð°ÑˆÐ¸ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹:\n{user_data[uid]['answers']}")

        # Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ñ‡Ð°ÑÑ‚ÑŒ â€” Ð·Ð°Ð²ÐµÑ€ÑˆÐ°ÑŽÑ‰Ð°Ñ Ñ„Ñ€Ð°Ð·Ð° + ÐºÐ½Ð¾Ð¿ÐºÐ° ÐºÑƒÐ¿Ð¸Ñ‚ÑŒ
        await bot.send_message(uid,
            "âœ¨ Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾! Ð’Ñ‹ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸ Ð´ÐµÐ¼Ð¾. âœ¨\n\n"
            "Ð•ÑÐ»Ð¸ Ð²Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»Ð½ÑƒÑŽ Ñ„Ð¸Ð·Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð³Ñ€Ñ‹ â€” Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ."
        )

        # WhatsApp ÐºÐ½Ð¾Ð¿ÐºÐ° Ð´Ð»Ñ Ð·Ð°ÐºÐ°Ð·Ð°
        wa_kb = InlineKeyboardMarkup().add(
            InlineKeyboardButton(
                "ðŸ›’ ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»Ð½ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ",
                url="https://wa.me/77079898845?text=Ð¯%20Ñ…Ð¾Ñ‡Ñƒ%20ÐºÑƒÐ¿Ð¸Ñ‚ÑŒ%20Ð¸Ð³Ñ€Ñƒ%20Â«Ð—ÐµÑ€ÐºÐ°Ð»Ð¾Â»"
            )
        )
        await bot.send_message(uid, "Ð—Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· WhatsApp:", reply_markup=wa_kb)


if _name_ == "_main_":
    executor.start_polling(dp, skip_updates=True)